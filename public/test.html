<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯­éŸ³AIåŠ©æ‰‹ - å¿«é€Ÿæµ‹è¯•é¡µé¢</title>
    <script src="https://static.cloudbase.net/cloudbase-js-sdk/2.17.5/cloudbase.full.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #1f2937;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
        }
        .test-section h2 {
            color: #374151;
            margin-top: 0;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin: 5px;
            transition: all 0.3s ease;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: 500;
        }
        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }
        .status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        .status.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        pre {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 14px;
        }
        .progress {
            width: 100%;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤ è¯­éŸ³AIåŠ©æ‰‹å¿«é€Ÿæµ‹è¯•</h1>
        
        <!-- CloudBase è¿æ¥æµ‹è¯• -->
        <div class="test-section">
            <h2>1. CloudBase è¿æ¥æµ‹è¯•</h2>
            <div id="cloudbase-status" class="status info">å‡†å¤‡æµ‹è¯•CloudBaseè¿æ¥...</div>
            <button onclick="testCloudBase()">æµ‹è¯•CloudBaseè¿æ¥</button>
            <div class="progress">
                <div id="cloudbase-progress" class="progress-bar"></div>
            </div>
            <pre id="cloudbase-result"></pre>
        </div>

        <!-- äº‘å‡½æ•°æµ‹è¯• -->
        <div class="test-section">
            <h2>2. äº‘å‡½æ•°è°ƒç”¨æµ‹è¯•</h2>
            <div id="functions-status" class="status info">å‡†å¤‡æµ‹è¯•äº‘å‡½æ•°è°ƒç”¨...</div>
            <button onclick="testAIChat()">æµ‹è¯•AIå¯¹è¯å‡½æ•°</button>
            <button onclick="testASR()">æµ‹è¯•è¯­éŸ³è¯†åˆ«å‡½æ•°</button>
            <button onclick="testTTS()">æµ‹è¯•è¯­éŸ³åˆæˆå‡½æ•°</button>
            <div class="progress">
                <div id="functions-progress" class="progress-bar"></div>
            </div>
            <pre id="functions-result"></pre>
        </div>

        <!-- éŸ³é¢‘æƒé™æµ‹è¯• -->
        <div class="test-section">
            <h2>3. éŸ³é¢‘æƒé™æµ‹è¯•</h2>
            <div id="audio-status" class="status info">å‡†å¤‡æµ‹è¯•éŸ³é¢‘æƒé™...</div>
            <button onclick="testAudioPermission()">æµ‹è¯•éº¦å…‹é£æƒé™</button>
            <button onclick="startRecording()" id="record-btn">å¼€å§‹å½•éŸ³</button>
            <button onclick="stopRecording()" id="stop-btn" disabled>åœæ­¢å½•éŸ³</button>
            <div class="progress">
                <div id="audio-progress" class="progress-bar"></div>
            </div>
            <canvas id="audio-canvas" width="400" height="100" style="border: 1px solid #e5e7eb; border-radius: 4px; margin: 10px 0;"></canvas>
            <pre id="audio-result"></pre>
        </div>

        <!-- ç³»ç»Ÿä¿¡æ¯ -->
        <div class="test-section">
            <h2>4. ç³»ç»Ÿä¿¡æ¯</h2>
            <div id="system-info">
                <p><strong>æµè§ˆå™¨:</strong> <span id="browser-info"></span></p>
                <p><strong>ç”¨æˆ·ä»£ç†:</strong> <span id="user-agent"></span></p>
                <p><strong>æ”¯æŒçš„åŠŸèƒ½:</strong></p>
                <ul id="features-list"></ul>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let app = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let audioContext = null;
        let analyser = null;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            updateSystemInfo();
            checkCloudBaseSDK();
        };
        
        // æ£€æŸ¥CloudBase SDKçŠ¶æ€
        function checkCloudBaseSDK() {
            const statusEl = document.getElementById('cloudbase-status');
            if (typeof cloudbase !== 'undefined') {
                statusEl.innerHTML = 'âœ… CloudBase SDKå·²åŠ è½½ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•';
                statusEl.className = 'status success';
            } else {
                statusEl.innerHTML = 'âŒ CloudBase SDKåŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢';
                statusEl.className = 'status error';
            }
        }

        // æ›´æ–°ç³»ç»Ÿä¿¡æ¯
        function updateSystemInfo() {
            document.getElementById('browser-info').textContent = navigator.userAgent.split(' ').pop();
            document.getElementById('user-agent').textContent = navigator.userAgent;
            
            const features = [
                { name: 'MediaRecorder API', supported: 'MediaRecorder' in window },
                { name: 'Web Audio API', supported: 'AudioContext' in window || 'webkitAudioContext' in window },
                { name: 'WebSocket', supported: 'WebSocket' in window },
                { name: 'Fetch API', supported: 'fetch' in window },
                { name: 'Promise', supported: 'Promise' in window }
            ];
            
            const featuresList = document.getElementById('features-list');
            features.forEach(feature => {
                const li = document.createElement('li');
                li.innerHTML = `${feature.name}: <span style="color: ${feature.supported ? '#059669' : '#dc2626'}">${feature.supported ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ'}</span>`;
                featuresList.appendChild(li);
            });
        }

        // æµ‹è¯•CloudBaseè¿æ¥
        async function testCloudBase() {
            const statusEl = document.getElementById('cloudbase-status');
            const progressEl = document.getElementById('cloudbase-progress');
            const resultEl = document.getElementById('cloudbase-result');
            
            try {
                // æ£€æŸ¥SDKæ˜¯å¦å¯ç”¨
                if (typeof cloudbase === 'undefined') {
                    throw new Error('CloudBase SDKæœªæ­£ç¡®åŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•æˆ–æ£€æŸ¥ç½‘ç»œè¿æ¥');
                }
                
                statusEl.textContent = 'æ­£åœ¨åˆå§‹åŒ–CloudBase...';
                statusEl.className = 'status info';
                progressEl.style.width = '20%';
                
                // åˆå§‹åŒ–CloudBase
                app = cloudbase.init({
                    env: 'cloud1-7g7oatv381500c81'
                });
                
                progressEl.style.width = '50%';
                
                // åŒ¿åç™»å½•
                statusEl.textContent = 'æ­£åœ¨è¿›è¡ŒåŒ¿åç™»å½•...';
                await app.auth().signInAnonymously();
                
                progressEl.style.width = '80%';
                
                // è·å–ç™»å½•çŠ¶æ€
                const loginState = await app.auth().getLoginState();
                
                progressEl.style.width = '100%';
                statusEl.textContent = 'CloudBaseè¿æ¥æˆåŠŸï¼';
                statusEl.className = 'status success';
                
                resultEl.textContent = JSON.stringify({
                    success: true,
                    env: 'cloud1-7g7oatv381500c81',
                    loginState: {
                        isLoggedIn: loginState.isLoggedIn,
                        loginType: loginState.loginType,
                        uid: loginState.user?.uid
                    }
                }, null, 2);
                
            } catch (error) {
                progressEl.style.width = '100%';
                statusEl.textContent = 'CloudBaseè¿æ¥å¤±è´¥: ' + error.message;
                statusEl.className = 'status error';
                resultEl.textContent = JSON.stringify({ error: error.message }, null, 2);
            }
        }

        // æµ‹è¯•AIå¯¹è¯å‡½æ•°
        async function testAIChat() {
            if (!app) {
                alert('è¯·å…ˆæµ‹è¯•CloudBaseè¿æ¥');
                return;
            }
            
            const statusEl = document.getElementById('functions-status');
            const progressEl = document.getElementById('functions-progress');
            const resultEl = document.getElementById('functions-result');
            
            try {
                statusEl.textContent = 'æ­£åœ¨è°ƒç”¨AIå¯¹è¯å‡½æ•°...';
                statusEl.className = 'status info';
                progressEl.style.width = '30%';
                
                progressEl.style.width = '60%';
                
                // ç›´æ¥è°ƒç”¨AIå‡½æ•°
                const result = await app.callFunction({
                    name: 'ai-chat',
                    data: {
                        messages: [
                            { role: 'user', content: 'Hello, this is a test message. How are you?' }
                        ],
                        userLevel: 'intermediate',
                        scenario: 'general'
                    }
                });
                
                progressEl.style.width = '100%';
                statusEl.textContent = 'AIå¯¹è¯å‡½æ•°æµ‹è¯•æˆåŠŸï¼';
                statusEl.className = 'status success';
                resultEl.textContent = JSON.stringify(result, null, 2);
                
            } catch (error) {
                progressEl.style.width = '100%';
                statusEl.textContent = 'AIå¯¹è¯å‡½æ•°æµ‹è¯•å¤±è´¥: ' + error.message;
                statusEl.className = 'status error';
                resultEl.textContent = JSON.stringify({ 
                    error: error.message,
                    suggestion: 'è¯·åœ¨CloudBaseæ§åˆ¶å°ä¸ºai-chatå‡½æ•°ç‚¹å‡»"äº‘ç«¯å®‰è£…ä¾èµ–"'
                }, null, 2);
            }
        }

        // æµ‹è¯•è¯­éŸ³è¯†åˆ«å‡½æ•°
        async function testASR() {
            if (!app) {
                alert('è¯·å…ˆæµ‹è¯•CloudBaseè¿æ¥');
                return;
            }
            
            const statusEl = document.getElementById('functions-status');
            const progressEl = document.getElementById('functions-progress');
            const resultEl = document.getElementById('functions-result');
            
            try {
                statusEl.textContent = 'æ­£åœ¨è°ƒç”¨è¯­éŸ³è¯†åˆ«å‡½æ•°...';
                statusEl.className = 'status info';
                progressEl.style.width = '30%';
                
                // ä½¿ç”¨æµ‹è¯•éŸ³é¢‘æ•°æ®
                const testAudio = btoa('test audio data');
                
                const result = await app.callFunction({
                    name: 'speech-recognition',
                    data: {
                        audio: testAudio,
                        language: 'en-US',
                        format: 'pcm',
                        sampleRate: 24000
                    }
                });
                
                progressEl.style.width = '100%';
                statusEl.textContent = 'è¯­éŸ³è¯†åˆ«å‡½æ•°æµ‹è¯•æˆåŠŸï¼';
                statusEl.className = 'status success';
                resultEl.textContent = JSON.stringify(result, null, 2);
                
            } catch (error) {
                progressEl.style.width = '100%';
                statusEl.textContent = 'è¯­éŸ³è¯†åˆ«å‡½æ•°æµ‹è¯•å¤±è´¥: ' + error.message;
                statusEl.className = 'status error';
                resultEl.textContent = JSON.stringify({ error: error.message }, null, 2);
            }
        }

        // æµ‹è¯•è¯­éŸ³åˆæˆå‡½æ•°
        async function testTTS() {
            if (!app) {
                alert('è¯·å…ˆæµ‹è¯•CloudBaseè¿æ¥');
                return;
            }
            
            const statusEl = document.getElementById('functions-status');
            const progressEl = document.getElementById('functions-progress');
            const resultEl = document.getElementById('functions-result');
            
            try {
                statusEl.textContent = 'æ­£åœ¨è°ƒç”¨è¯­éŸ³åˆæˆå‡½æ•°...';
                statusEl.className = 'status info';
                progressEl.style.width = '30%';
                
                const result = await app.callFunction({
                    name: 'text-to-speech',
                    data: {
                        text: 'Hello, this is a test message for text to speech synthesis.',
                        voice: 'female'
                    }
                });
                
                progressEl.style.width = '100%';
                statusEl.textContent = 'è¯­éŸ³åˆæˆå‡½æ•°æµ‹è¯•æˆåŠŸï¼';
                statusEl.className = 'status success';
                resultEl.textContent = JSON.stringify({
                    success: result.success,
                    method: result.method,
                    audioLength: result.audio ? result.audio.length : 0
                }, null, 2);
                
            } catch (error) {
                progressEl.style.width = '100%';
                statusEl.textContent = 'è¯­éŸ³åˆæˆå‡½æ•°æµ‹è¯•å¤±è´¥: ' + error.message;
                statusEl.className = 'status error';
                resultEl.textContent = JSON.stringify({ error: error.message }, null, 2);
            }
        }

        // æµ‹è¯•éŸ³é¢‘æƒé™
        async function testAudioPermission() {
            const statusEl = document.getElementById('audio-status');
            const progressEl = document.getElementById('audio-progress');
            const resultEl = document.getElementById('audio-result');
            
            try {
                statusEl.textContent = 'æ­£åœ¨è¯·æ±‚éº¦å…‹é£æƒé™...';
                statusEl.className = 'status info';
                progressEl.style.width = '30%';
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        sampleRate: 24000,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true
                    } 
                });
                
                progressEl.style.width = '70%';
                
                // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                source.connect(analyser);
                
                progressEl.style.width = '100%';
                statusEl.textContent = 'éŸ³é¢‘æƒé™è·å–æˆåŠŸï¼å¯ä»¥å¼€å§‹å½•éŸ³æµ‹è¯•';
                statusEl.className = 'status success';
                
                document.getElementById('record-btn').disabled = false;
                
                // å¼€å§‹éŸ³é¢‘å¯è§†åŒ–
                drawAudioVisualization();
                
                resultEl.textContent = JSON.stringify({
                    success: true,
                    audioContext: {
                        sampleRate: audioContext.sampleRate,
                        state: audioContext.state
                    },
                    mediaStream: {
                        active: stream.active,
                        audioTracks: stream.getAudioTracks().length
                    }
                }, null, 2);
                
            } catch (error) {
                progressEl.style.width = '100%';
                statusEl.textContent = 'éŸ³é¢‘æƒé™è·å–å¤±è´¥: ' + error.message;
                statusEl.className = 'status error';
                resultEl.textContent = JSON.stringify({ error: error.message }, null, 2);
            }
        }

        // å¼€å§‹å½•éŸ³
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    document.getElementById('audio-result').textContent = 
                        `å½•éŸ³å®Œæˆï¼éŸ³é¢‘å¤§å°: ${audioBlob.size} å­—èŠ‚`;
                    audioChunks = [];
                };
                
                mediaRecorder.start();
                document.getElementById('record-btn').disabled = true;
                document.getElementById('stop-btn').disabled = false;
                document.getElementById('audio-status').textContent = 'æ­£åœ¨å½•éŸ³...';
                document.getElementById('audio-status').className = 'status info';
                
            } catch (error) {
                alert('å½•éŸ³å¯åŠ¨å¤±è´¥: ' + error.message);
            }
        }

        // åœæ­¢å½•éŸ³
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                document.getElementById('record-btn').disabled = false;
                document.getElementById('stop-btn').disabled = true;
                document.getElementById('audio-status').textContent = 'å½•éŸ³å·²åœæ­¢';
                document.getElementById('audio-status').className = 'status success';
            }
        }

        // éŸ³é¢‘å¯è§†åŒ–
        function drawAudioVisualization() {
            if (!analyser) return;
            
            const canvas = document.getElementById('audio-canvas');
            const ctx = canvas.getContext('2d');
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            
            function draw() {
                requestAnimationFrame(draw);
                
                analyser.getByteFrequencyData(dataArray);
                
                ctx.fillStyle = '#f3f4f6';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                const barWidth = (canvas.width / bufferLength) * 2.5;
                let barHeight;
                let x = 0;
                
                for (let i = 0; i < bufferLength; i++) {
                    barHeight = (dataArray[i] / 255) * canvas.height;
                    
                    const gradient = ctx.createLinearGradient(0, canvas.height - barHeight, 0, canvas.height);
                    gradient.addColorStop(0, '#667eea');
                    gradient.addColorStop(1, '#764ba2');
                    
                    ctx.fillStyle = gradient;
                    ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                    
                    x += barWidth + 1;
                }
            }
            
            draw();
        }
    </script>
</body>
</html>