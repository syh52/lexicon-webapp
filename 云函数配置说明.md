# 🔧 语音识别和语音合成云函数配置说明

## 📋 **更新内容总结**

### ✅ **已完成的优化**

1. **统一API配置** - 两个云函数都使用 `https://www.chataiapi.com/v1` 作为API Base
2. **增强参数支持** - 支持New API文档中的所有标准参数
3. **改进错误处理** - 标准化错误响应格式
4. **优化代码结构** - 更好的参数验证和日志记录

## 🔑 **环境变量配置**

请在CloudBase控制台的云函数环境变量中设置以下变量：

```bash
# 主要API Key（推荐使用这个）
OPENAI_API_KEY=sk-MVwM0Y77CDZbTMT0cFoDe5WSZuYZk1G64dMWE6hpBitqgkgT

# 可选的备用Key名称（为了兼容性保留）
GPTS_VIN_API_KEY=sk-MVwM0Y77CDZbTMT0cFoDe5WSZuYZk1G64dMWE6hpBitqgkgT

# API Base URL（可选，默认使用 https://www.chataiapi.com/v1）
OPENAI_API_BASE=https://www.chataiapi.com/v1
```

## 🎤 **语音识别云函数 (speech-recognition)**

### **支持的参数**
```javascript
{
  "audio": "base64音频数据", // 必填
  "language": "en", // 可选，默认 'en'，支持自动检测 'auto'
  "format": "wav", // 可选，默认 'wav'，支持 mp3, wav 等
  "prompt": "提示词", // 可选，帮助提高识别准确性
  "response_format": "json", // 可选，默认 'json'，支持 text, srt, vtt 等
  "temperature": 0 // 可选，默认 0，控制输出随机性 (0-1)
}
```

### **响应格式**
```javascript
{
  "success": true,
  "text": "识别出的文本",
  "duration": 5.23, // 音频时长（秒）
  "language": "en", // 检测到的语言
  "segments": [], // 详细分段信息（如果可用）
  "method": "openai-whisper",
  "model": "whisper-1",
  "timestamp": "2025-01-22T..."
}
```

## 🔊 **语音合成云函数 (text-to-speech)**

### **支持的参数**
```javascript
{
  "text": "要合成的文本", // 必填，最大4096字符
  "voice": "alloy", // 可选，默认 'alloy'
  "speed": 1.0, // 可选，默认 1.0，范围 0.25-4.0
  "format": "mp3", // 可选，默认 'mp3'
  "model": "tts-1" // 可选，默认 'tts-1'，支持 'tts-1-hd'
}
```

### **支持的语音类型**
- `alloy` - 中性音色
- `echo` - 男性音色  
- `fable` - 英式男性音色
- `onyx` - 深沉男性音色
- `nova` - 女性音色
- `shimmer` - 柔和女性音色

### **响应格式**
```javascript
{
  "success": true,
  "audio": "base64音频数据",
  "sessionId": "1642895234567",
  "method": "openai-tts",
  "format": "mp3",
  "size": 12345, // 音频字节大小
  "model": "tts-1",
  "voice": "alloy",
  "speed": 1.0,
  "timestamp": "2025-01-22T..."
}
```

## 🛡️ **错误处理**

所有错误响应都遵循New API标准格式：

```javascript
{
  "success": false,
  "error": {
    "message": "错误描述",
    "type": "invalid_request_error", 
    "code": "processing_error"
  },
  "timestamp": "2025-01-22T..."
}
```

## 🔄 **降级机制**

两个云函数都包含智能降级机制：

1. **API调用成功** - 返回真实的AI处理结果
2. **API调用失败** - 自动降级为模拟数据，确保系统可用性
3. **未配置API Key** - 使用模拟数据，便于开发测试

## 🚀 **部署命令**

```bash
# 部署语音识别云函数
cloudbase functions:deploy speech-recognition

# 部署语音合成云函数
cloudbase functions:deploy text-to-speech

# 或使用MCP工具部署
# 会自动读取cloudfunctions目录下的函数代码并部署
```

## 📝 **使用示例**

### 语音识别调用示例
```javascript
const result = await app.callFunction({
  name: 'speech-recognition',
  data: {
    audio: 'base64音频数据',
    language: 'en',
    prompt: '这是英语学习内容'
  }
});
console.log(result.result.text); // 识别结果
```

### 语音合成调用示例
```javascript
const result = await app.callFunction({
  name: 'text-to-speech',
  data: {
    text: 'Hello, this is a test.',
    voice: 'nova',
    speed: 1.2
  }
});
console.log(result.result.audio); // base64音频数据
```

## ✨ **主要改进**

1. **完全兼容New API标准** - 支持所有文档中的参数和响应格式
2. **统一配置** - 使用一致的API Base和Key配置
3. **增强验证** - 对所有输入参数进行严格验证  
4. **改进日志** - 更详细的调试和错误信息
5. **标准化响应** - 遵循一致的响应格式规范

现在您的语音识别和语音合成云函数已完全符合您的中转API服务标准！🎉