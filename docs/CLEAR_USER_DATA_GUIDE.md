# 用户数据清除功能使用指南

## 📋 功能概述

在开发测试阶段，我们为系统添加了用户数据清除功能，用于清除每个用户的学习记录和记忆数据。这个功能对于：
- 🧪 **开发测试** - 清除测试数据，重新开始测试
- 🔄 **数据重置** - 为用户提供重新开始学习的选项
- 🐛 **故障排除** - 清除可能损坏的数据记录

## 🔧 功能组件

### 1. 云函数：`clear-user-data`

**位置**: `/cloudfunctions/clear-user-data/`

**支持的操作**:
- `clear_user_study_records` - 清除用户学习记录
- `clear_user_daily_plans` - 清除用户每日计划
- `clear_all_user_data` - 清除用户所有数据
- `get_user_data_stats` - 获取用户数据统计
- `list_all_users` - 列出所有有数据的用户

### 2. 管理员界面

**位置**: 管理员页面 → 数据管理标签页
**权限**: 仅超级管理员可访问

## 🔐 安全机制

### 管理员密钥验证
- 所有操作都需要管理员密钥：`LEXICON_SUPER_ADMIN_2025`
- 密钥验证失败将拒绝所有操作

### 多重确认机制
1. **界面确认** - 操作按钮需要用户点击确认
2. **浏览器确认** - 使用 `confirm()` 对话框二次确认
3. **文本确认** - 危险操作需要输入特定文本确认

### 操作权限控制
- 只有超级管理员可以访问数据管理页面
- 普通管理员无法执行清除操作

## 🖥️ 使用步骤

### 1. 访问管理页面
1. 使用超级管理员账户登录
2. 访问 `/admin` 页面
3. 点击 "数据管理" 标签页

### 2. 查看用户数据
1. 点击 "刷新数据" 按钮加载所有用户
2. 在左侧用户列表中选择要操作的用户
3. 右侧会显示该用户的详细数据统计

### 3. 执行清除操作

#### 清除学习记录
```
点击 "清除学习记录" → 确认操作 → 等待完成
```

#### 清除每日计划
```
点击 "清除每日计划" → 确认操作 → 等待完成
```

#### 清除所有数据 ⚠️
```
点击 "清除所有数据" → 输入确认文本 "YES_DELETE_ALL_DATA" → 等待完成
```

## 📊 数据统计说明

每个用户的数据统计包括：

| 字段 | 说明 |
|------|------|
| 学习记录 | SM2算法生成的单词学习记录数量 |
| 每日计划 | 用户的每日学习计划数量 |
| 用户设置 | 用户的个性化设置数量 |
| 最后学习时间 | 用户最后一次学习的时间 |

## 🔄 云函数API调用示例

### 获取用户数据统计
```javascript
const result = await app.callFunction({
  name: 'clear-user-data',
  data: {
    action: 'get_user_data_stats',
    adminKey: 'LEXICON_SUPER_ADMIN_2025',
    uid: 'user-id-here'
  }
});
```

### 清除用户学习记录
```javascript
const result = await app.callFunction({
  name: 'clear-user-data',
  data: {
    action: 'clear_user_study_records',
    adminKey: 'LEXICON_SUPER_ADMIN_2025',
    uid: 'user-id-here',
    wordbookId: 'optional-wordbook-id' // 可选，指定词书
  }
});
```

### 清除所有用户数据
```javascript
const result = await app.callFunction({
  name: 'clear-user-data',
  data: {
    action: 'clear_all_user_data',
    adminKey: 'LEXICON_SUPER_ADMIN_2025',
    uid: 'user-id-here',
    confirm: 'YES_DELETE_ALL_DATA'
  }
});
```

## ⚠️ 重要注意事项

### 数据不可恢复
- 所有清除操作都是**永久性**的
- 删除的数据无法恢复
- 请在操作前确认数据已备份（如需要）

### 性能考虑
- 大量数据的清除可能需要较长时间
- 云函数有60秒的超时限制
- 如果数据量过大，考虑分批处理

### 并发操作
- 避免同时对同一用户执行多个清除操作
- 操作完成前请勿重复点击按钮

## 🚨 故障排除

### 常见错误及解决方案

#### 1. "无效的管理员密钥"
- 检查代码中的管理员密钥是否正确
- 确认云函数中的密钥常量未被修改

#### 2. "用户ID不能为空"
- 确保选择了有效的用户
- 检查用户ID格式是否正确

#### 3. "清除操作超时"
- 用户数据量可能过大
- 考虑先清除部分数据，然后再清除剩余数据

#### 4. "权限不足"
- 确认当前用户是超级管理员
- 检查用户角色和权限设置

## 📝 开发调试

### 本地测试
运行测试脚本验证云函数逻辑：
```bash
node test-clear-function.js
```

### 日志查看
在云函数控制台查看详细的执行日志和错误信息。

### 数据库检查
清除操作后，可以在数据库控制台验证数据是否已正确删除。

## 🔮 未来改进

- [ ] 添加数据备份功能
- [ ] 支持批量用户操作
- [ ] 添加操作日志记录
- [ ] 实现定时清理功能
- [ ] 添加数据导出功能

---

**⚠️ 重要提醒**: 此功能仅限开发测试使用，在生产环境中请谨慎使用，确保有适当的数据备份和权限控制机制。